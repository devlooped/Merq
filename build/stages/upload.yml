# Upload Stage

stages:
- stage: Upload
  dependsOn:
  - Build
  - Compliance
  jobs:
  - job: Upload
    pool:
      name: AzurePipelines-EO
      demands:
      - ImageOverride -equals AzurePipelinesWindows2022compliant

    steps:
    - checkout: self

    - task: UseDotNet@2
      inputs:
        packageType: runtime
        version: $(DotNetVersion)
        performMultiLevelLookup: true
    - script: 'dotnet tool update -g --version 7.0.0 PowerShell >nul || dotnet tool list -g'
      displayName: UsePowerShell

    - task: DownloadBuildArtifacts@0
      inputs:
        artifactName: package

    - template: dump-environment.yml@templates
    - template: upload-to-storage/win/v1.yml@templates
      parameters:
        ArtifactsDirectory: '$(Build.ArtifactStagingDirectory)/package'
        Azure.ContainerName: 'xvs-merq'
        GitHub.Context: 'artifacts'

    - task: NuGetCommand@2
      displayName: Push Packages
      continueOnError: true
      condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['PushPackages'], 'true')))
      inputs:
        command: push
        packagesToPush: $(Build.ArtifactStagingDirectory)/package/*.nupkg
        nuGetFeedType: external
        publishFeedCredentials: 'xamarin-impl public feed'
